(function(dndLists){var MIME_TYPE="application/x-dnd";var EDGE_MIME_TYPE="application/json";var MSIE_MIME_TYPE="Text";var ALL_EFFECTS=["move","copy","link"];dndLists.directive("dndDraggable",["$parse","$timeout",function($parse,$timeout){return function(scope,element,attr){element.attr("draggable","true");if(attr.dndDisableIf){scope.$watch(attr.dndDisableIf,function(disabled){element.attr("draggable",!disabled)})}element.on("dragstart",function(event){event=event.originalEvent||event;if(element.attr("draggable")=="false")return true;dndState.isDragging=true;dndState.itemType=attr.dndType&&scope.$eval(attr.dndType).toLowerCase();dndState.dropEffect="none";dndState.effectAllowed=attr.dndEffectAllowed||ALL_EFFECTS[0];event.dataTransfer.effectAllowed=dndState.effectAllowed;var item=scope.$eval(attr.dndDraggable);var mimeType=MIME_TYPE+(dndState.itemType?"-"+dndState.itemType:"");try{event.dataTransfer.setData(mimeType,angular.toJson(item))}catch(e){var data=angular.toJson({item:item,type:dndState.itemType});try{event.dataTransfer.setData(EDGE_MIME_TYPE,data)}catch(e){var effectsAllowed=filterEffects(ALL_EFFECTS,dndState.effectAllowed);event.dataTransfer.effectAllowed=effectsAllowed[0];event.dataTransfer.setData(MSIE_MIME_TYPE,data)}}element.addClass("dndDragging");$timeout(function(){element.addClass("dndDraggingSource")},0);if(event._dndHandle&&event.dataTransfer.setDragImage){event.dataTransfer.setDragImage(element[0],0,0)}$parse(attr.dndDragstart)(scope,{event:event});if(attr.dndCallback){var callback=$parse(attr.dndCallback);dndState.callback=function(params){return callback(scope,params||{})}}event.stopPropagation()});element.on("dragend",function(event){event=event.originalEvent||event;scope.$apply(function(){var dropEffect=dndState.dropEffect;var cb={copy:"dndCopied",link:"dndLinked",move:"dndMoved",none:"dndCanceled"};$parse(attr[cb[dropEffect]])(scope,{event:event});$parse(attr.dndDragend)(scope,{event:event,dropEffect:dropEffect})});dndState.isDragging=false;dndState.callback=undefined;element.removeClass("dndDragging");element.removeClass("dndDraggingSource");event.stopPropagation();$timeout(function(){element.removeClass("dndDraggingSource")},0)});element.on("click",function(event){if(!attr.dndSelected)return;event=event.originalEvent||event;scope.$apply(function(){$parse(attr.dndSelected)(scope,{event:event})});event.stopPropagation()});element.on("selectstart",function(){if(this.dragDrop)this.dragDrop()})}}]);dndLists.directive("dndList",["$parse",function($parse){return function(scope,element,attr){var placeholder=getPlaceholderElement();placeholder.remove();var placeholderNode=placeholder[0];var listNode=element[0];var listSettings={};element.on("dragenter",function(event){event=event.originalEvent||event;var types=attr.dndAllowedTypes&&scope.$eval(attr.dndAllowedTypes);listSettings={allowedTypes:angular.isArray(types)&&types.join("|").toLowerCase().split("|"),disabled:attr.dndDisableIf&&scope.$eval(attr.dndDisableIf),externalSources:attr.dndExternalSources&&scope.$eval(attr.dndExternalSources),horizontal:attr.dndHorizontalList&&scope.$eval(attr.dndHorizontalList)};var mimeType=getMimeType(event.dataTransfer.types);if(!mimeType||!isDropAllowed(getItemType(mimeType)))return true;event.preventDefault()});element.on("dragover",function(event){event=event.originalEvent||event;var mimeType=getMimeType(event.dataTransfer.types);var itemType=getItemType(mimeType);if(!mimeType||!isDropAllowed(itemType))return true;if(placeholderNode.parentNode!=listNode){element.append(placeholder)}if(event.target!=listNode){var listItemNode=event.target;while(listItemNode.parentNode!=listNode&&listItemNode.parentNode){listItemNode=listItemNode.parentNode}if(listItemNode.parentNode==listNode&&listItemNode!=placeholderNode){var rect=listItemNode.getBoundingClientRect();if(listSettings.horizontal){var isFirstHalf=event.clientX<rect.left+rect.width/2}else{var isFirstHalf=event.clientY<rect.top+rect.height/2}if(isFirstHalf){if(listItemNode.previousSibling!=placeholderNode)listNode.insertBefore(placeholderNode,listItemNode)}else{if(listItemNode.nextSibling!=placeholderNode)listNode.insertBefore(placeholderNode,listItemNode.nextSibling)}}}var ignoreDataTransfer=mimeType==MSIE_MIME_TYPE;var dropEffect=getDropEffect(event,ignoreDataTransfer);if(dropEffect=="none")return stopDragover();if(attr.dndDragover&&!invokeCallback(attr.dndDragover,event,dropEffect,itemType)){return stopDragover()}event.preventDefault();if(!ignoreDataTransfer){event.dataTransfer.dropEffect=dropEffect}element.addClass("dndDragover");event.stopPropagation();return false});element.on("drop",function(event){event=event.originalEvent||event;var mimeType=getMimeType(event.dataTransfer.types);var itemType=getItemType(mimeType);if(!mimeType||!isDropAllowed(itemType))return true;event.preventDefault();try{var data=JSON.parse(event.dataTransfer.getData(mimeType))}catch(e){return stopDragover()}if(mimeType==MSIE_MIME_TYPE||mimeType==EDGE_MIME_TYPE){itemType=data.type||undefined;data=data.item;if(!isDropAllowed(itemType))return stopDragover()}var ignoreDataTransfer=mimeType==MSIE_MIME_TYPE;var dropEffect=getDropEffect(event,ignoreDataTransfer);if(dropEffect=="none")return stopDragover();var index=getPlaceholderIndex();if(attr.dndDrop){data=invokeCallback(attr.dndDrop,event,dropEffect,itemType,index,data);if(!data)return stopDragover()}dndState.dropEffect=dropEffect;if(!ignoreDataTransfer){event.dataTransfer.dropEffect=dropEffect}if(data!==true){scope.$apply(function(){scope.$eval(attr.dndList).splice(index,0,data)})}invokeCallback(attr.dndInserted,event,dropEffect,itemType,index,data);stopDragover();event.stopPropagation();return false});element.on("dragleave",function(event){event=event.originalEvent||event;var newTarget=document.elementFromPoint(event.clientX,event.clientY);if(listNode.contains(newTarget)&&!event._dndPhShown){event._dndPhShown=true}else{stopDragover()}});function getMimeType(types){if(!types)return MSIE_MIME_TYPE;for(var i=0;i<types.length;i++){if(types[i]==MSIE_MIME_TYPE||types[i]==EDGE_MIME_TYPE||types[i].substr(0,MIME_TYPE.length)==MIME_TYPE){return types[i]}}return null}function getItemType(mimeType){if(dndState.isDragging)return dndState.itemType||undefined;if(mimeType==MSIE_MIME_TYPE||mimeType==EDGE_MIME_TYPE)return null;return mimeType&&mimeType.substr(MIME_TYPE.length+1)||undefined}function isDropAllowed(itemType){if(listSettings.disabled)return false;if(!listSettings.externalSources&&!dndState.isDragging)return false;if(!listSettings.allowedTypes||itemType===null)return true;return itemType&&listSettings.allowedTypes.indexOf(itemType)!=-1}function getDropEffect(event,ignoreDataTransfer){var effects=ALL_EFFECTS;if(!ignoreDataTransfer){effects=filterEffects(effects,event.dataTransfer.effectAllowed)}if(dndState.isDragging){effects=filterEffects(effects,dndState.effectAllowed)}if(attr.dndEffectAllowed){effects=filterEffects(effects,attr.dndEffectAllowed)}if(!effects.length){return"none"}else if(event.ctrlKey&&effects.indexOf("copy")!=-1){return"copy"}else if(event.altKey&&effects.indexOf("link")!=-1){return"link"}else{return effects[0]}}function stopDragover(){placeholder.remove();element.removeClass("dndDragover");return true}function invokeCallback(expression,event,dropEffect,itemType,index,item){return $parse(expression)(scope,{callback:dndState.callback,dropEffect:dropEffect,event:event,external:!dndState.isDragging,index:index!==undefined?index:getPlaceholderIndex(),item:item||undefined,type:itemType})}function getPlaceholderIndex(){return Array.prototype.indexOf.call(listNode.children,placeholderNode)}function getPlaceholderElement(){var placeholder;angular.forEach(element.children(),function(childNode){var child=angular.element(childNode);if(child.hasClass("dndPlaceholder")){placeholder=child}});return placeholder||angular.element("<li class='dndPlaceholder'></li>")}}}]);dndLists.directive("dndNodrag",function(){return function(scope,element,attr){element.attr("draggable","true");element.on("dragstart",function(event){event=event.originalEvent||event;if(!event._dndHandle){if(!(event.dataTransfer.types&&event.dataTransfer.types.length)){event.preventDefault()}event.stopPropagation()}});element.on("dragend",function(event){event=event.originalEvent||event;if(!event._dndHandle){event.stopPropagation()}})}});dndLists.directive("dndHandle",function(){return function(scope,element,attr){element.attr("draggable","true");element.on("dragstart dragend",function(event){event=event.originalEvent||event;event._dndHandle=true})}});function filterEffects(effects,effectAllowed){if(effectAllowed=="all")return effects;return effects.filter(function(effect){return effectAllowed.toLowerCase().indexOf(effect)!=-1})}var dndState={}})(angular.module("dndLists",[]));